<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¢æœæ©Ÿå™¨äººåˆ†æå„€è¡¨æ¿</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&family=DM+Sans:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #fafbfe;
            --bg-card: #ffffff;
            --bg-input: #f3f4f8;
            --accent: #4361ee;
            --accent-soft: rgba(67, 97, 238, 0.08);
            --accent-light: #6c83f5;
            --text: #1a1d2e;
            --text-light: #6b7194;
            --text-muted: #9ea3bf;
            --border: #e8eaf2;
            --success: #22c55e;
            --success-soft: rgba(34, 197, 94, 0.08);
            --warning: #f59e0b;
            --warning-soft: rgba(245, 158, 11, 0.08);
            --error: #ef4444;
            --error-soft: rgba(239, 68, 68, 0.08);
            --shadow: 0 1px 3px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.02);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.05);
            --radius: 16px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans TC', 'DM Sans', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }

        /* â•â•â•â•â•â• Header â•â•â•â•â•â• */
        .header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 18px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .header-left {
            display: flex; align-items: center; gap: 12px;
        }

        .header-icon {
            width: 40px; height: 40px;
            background: var(--accent);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 18px; color: #fff;
            box-shadow: 0 2px 8px rgba(67, 97, 238, 0.3);
        }

        .header h1 { font-size: 16px; font-weight: 600; }
        .header p { font-size: 12px; color: var(--text-muted); }

        .header-actions {
            display: flex; gap: 8px; align-items: center;
        }

        .period-btn {
            padding: 7px 16px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-light);
            font-size: 13px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.15s;
        }

        .period-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }

        .period-btn:hover:not(.active) {
            border-color: var(--accent);
            color: var(--accent);
        }

        .refresh-btn {
            padding: 7px 16px;
            background: var(--accent);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
            font-family: inherit;
            transition: transform 0.1s;
        }

        .refresh-btn:active { transform: scale(0.96); }

        /* â•â•â•â•â•â• Grid â•â•â•â•â•â• */
        .grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            padding: 24px 32px;
            max-width: 1280px;
            margin: 0 auto;
        }

        /* â•â•â•â•â•â• Stat Cards â•â•â•â•â•â• */
        .stat {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            transition: transform 0.15s, box-shadow 0.15s;
        }

        .stat:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 500;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 30px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text);
            line-height: 1.1;
        }

        .stat-sub {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 6px;
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-value.danger { color: var(--error); }
        .stat-value.warn { color: var(--warning); }
        .stat-value.good { color: var(--success); }

        /* â•â•â•â•â•â• Card â•â•â•â•â•â• */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 22px;
            box-shadow: var(--shadow);
        }

        .card.span2 { grid-column: span 2; }
        .card.span4 { grid-column: span 4; }

        .card-head {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            display: flex; align-items: center; gap: 8px;
        }

        .card-title span { font-size: 16px; }

        .card-badge {
            font-size: 11px;
            padding: 3px 10px;
            border-radius: 8px;
            font-family: 'JetBrains Mono', monospace;
        }

        /* â•â•â•â•â•â• Table â•â•â•â•â•â• */
        .tbl { width: 100%; border-collapse: collapse; }

        .tbl th {
            text-align: left;
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            padding: 8px 10px;
            border-bottom: 1px solid var(--border);
        }

        .tbl td {
            padding: 11px 10px;
            font-size: 13px;
            border-bottom: 1px solid var(--bg);
        }

        .tbl tr:last-child td { border-bottom: none; }
        .tbl tr:hover td { background: var(--accent-soft); }

        .rank-num {
            width: 26px; height: 26px;
            border-radius: 8px;
            display: inline-flex;
            align-items: center; justify-content: center;
            font-size: 12px; font-weight: 600;
            font-family: 'JetBrains Mono', monospace;
            background: var(--bg);
            color: var(--text-light);
        }

        .rank-num.first {
            background: var(--accent);
            color: #fff;
        }

        .count-pill {
            padding: 2px 10px;
            background: var(--bg);
            border-radius: 10px;
            font-size: 12px;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-light);
        }

        .conf-badge {
            padding: 2px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            font-weight: 500;
        }

        .conf-badge.high { background: var(--success-soft); color: var(--success); }
        .conf-badge.mid { background: var(--warning-soft); color: var(--warning); }
        .conf-badge.low { background: var(--error-soft); color: var(--error); }

        /* â•â•â•â•â•â• Gap Items â•â•â•â•â•â• */
        .gap-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 11px 14px;
            background: var(--bg);
            border-radius: 10px;
            margin-bottom: 6px;
            border-left: 3px solid var(--error);
        }

        .gap-item:last-child { margin-bottom: 0; }
        .gap-item .q { font-size: 13px; flex: 1; }
        .gap-item .c { font-size: 11px; font-family: 'JetBrains Mono', monospace; color: var(--error); }

        /* â•â•â•â•â•â• Bar Chart â•â•â•â•â•â• */
        .bars { display: flex; flex-direction: column; gap: 8px; }

        .bar-row { display: flex; align-items: center; gap: 10px; }

        .bar-label {
            width: 100px; font-size: 12px;
            color: var(--text-light);
            text-align: right; flex-shrink: 0;
            overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
        }

        .bar-track {
            flex: 1; height: 28px;
            background: var(--bg);
            border-radius: 8px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            border-radius: 8px;
            background: linear-gradient(90deg, var(--accent), var(--accent-light));
            display: flex; align-items: center;
            padding-left: 10px;
            font-size: 11px;
            font-family: 'JetBrains Mono', monospace;
            color: #fff;
            min-width: 36px;
            transition: width 0.6s ease;
        }

        .bar-fill.green {
            background: linear-gradient(90deg, var(--success), #4ade80);
        }

        /* â•â•â•â•â•â• Summary â•â•â•â•â•â• */
        .summary-box {
            font-size: 14px;
            line-height: 1.9;
            color: var(--text-light);
        }

        .summary-box h3, .summary-box h4 {
            color: var(--text);
            font-size: 14px;
            font-weight: 600;
            margin-top: 14px;
            margin-bottom: 4px;
        }

        .summary-box strong { color: var(--text); }

        .summary-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            padding: 30px;
            color: var(--text-muted);
            font-size: 13px;
        }

        .gen-btn {
            padding: 9px 20px;
            background: var(--accent);
            border: none;
            border-radius: 10px;
            color: #fff;
            font-size: 13px;
            cursor: pointer;
            font-family: inherit;
            transition: transform 0.1s;
        }

        .gen-btn:active { transform: scale(0.96); }
        .gen-btn:disabled { opacity: 0.5; cursor: wait; }

        /* â•â•â•â•â•â• Empty State â•â•â•â•â•â• */
        .empty {
            padding: 20px;
            text-align: center;
            color: var(--text-muted);
            font-size: 13px;
        }

        .empty.success { color: var(--success); }

        /* â•â•â•â•â•â• Spinner â•â•â•â•â•â• */
        .spin {
            width: 20px; height: 20px;
            border: 2.5px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            display: inline-block;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        .page-loading {
            grid-column: span 4;
            display: flex;
            align-items: center; justify-content: center;
            gap: 10px;
            padding: 60px;
            color: var(--text-muted);
            font-size: 14px;
        }

        /* â•â•â•â•â•â• Responsive â•â•â•â•â•â• */
        @media (max-width: 900px) {
            .grid { grid-template-columns: repeat(2, 1fr); padding: 16px; }
            .card.span2 { grid-column: span 2; }
            .card.span4 { grid-column: span 2; }
        }

        @media (max-width: 600px) {
            .grid { grid-template-columns: 1fr; padding: 12px; }
            .card.span2, .card.span4 { grid-column: span 1; }
            .header { padding: 14px 16px; }
            .header-actions { display: none; }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-left">
        <div class="header-icon">ğŸ“Š</div>
        <div>
            <h1>åˆ†æå„€è¡¨æ¿</h1>
            <p>å®¢æœæ©Ÿå™¨äººæ•¸æ“šæ´å¯Ÿ</p>
        </div>
    </div>
    <div class="header-actions">
        <button class="period-btn" onclick="load(7, this)">7å¤©</button>
        <button class="period-btn active" onclick="load(30, this)">30å¤©</button>
        <button class="period-btn" onclick="load(90, this)">90å¤©</button>
        <button class="refresh-btn" onclick="load(days)">ğŸ”„ é‡æ–°æ•´ç†</button>
    </div>
</div>

<div class="grid" id="grid">
    <div class="page-loading"><div class="spin"></div> è¼‰å…¥ä¸­...</div>
</div>

<script>
const API = window.location.origin;
let days = 30;

async function load(d, btn) {
    days = d || days;

    if (btn) {
        document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    const g = document.getElementById('grid');
    g.innerHTML = '<div class="page-loading"><div class="spin"></div> è¼‰å…¥ä¸­...</div>';

    try {
        // Load overview and trends first (fast), skip weekly summary (slow GPT call)
        const [overview, trends] = await Promise.all([
            fetch(`${API}/api/analytics/overview?days=${days}`).then(r => r.json()),
            fetch(`${API}/api/analytics/trends?days=${days}`).then(r => r.json()),
        ]);

        render(overview, trends);
    } catch(e) {
        g.innerHTML = '<div class="page-loading">âŒ ç„¡æ³•è¼‰å…¥æ•¸æ“š</div>';
        console.error(e);
    }
}

function render(ov, trends) {
    const e = ov.engagement || {};
    const u = ov.unanswered || {};
    const lc = ov.low_confidence || {};
    const uRate = u.rate_percent || 0;
    const lcRate = lc.rate_percent || 0;

    document.getElementById('grid').innerHTML = `
        <!-- Stats -->
        <div class="stat">
            <div class="stat-label">ç¸½è¨Šæ¯æ•¸</div>
            <div class="stat-value">${e.total_messages || 0}</div>
            <div class="stat-sub">éå» ${days} å¤©</div>
        </div>
        <div class="stat">
            <div class="stat-label">ç¨ç«‹è¨ªå®¢</div>
            <div class="stat-value">${e.total_sessions || 0}</div>
            <div class="stat-sub">æ—¥å‡ ${e.avg_messages_per_day || 0} å‰‡è¨Šæ¯</div>
        </div>
        <div class="stat">
            <div class="stat-label">æœªè§£ç­”ç‡</div>
            <div class="stat-value ${uRate > 15 ? 'danger' : uRate > 5 ? 'warn' : 'good'}">${uRate}%</div>
            <div class="stat-sub">${u.count || 0} å‰‡æœªè§£ç­”</div>
        </div>
        <div class="stat">
            <div class="stat-label">ä½ä¿¡å¿ƒåº¦</div>
            <div class="stat-value ${lcRate > 20 ? 'danger' : lcRate > 10 ? 'warn' : 'good'}">${lcRate}%</div>
            <div class="stat-sub">${lc.count || 0} å‰‡ä½æ–¼é–€æª»</div>
        </div>

        <!-- Top Questions -->
        <div class="card span2">
            <div class="card-head">
                <div class="card-title"><span>ğŸ”¥</span> ç†±é–€å•é¡Œ</div>
            </div>
            ${renderTopQ(ov.top_questions || [])}
        </div>

        <!-- Unanswered -->
        <div class="card span2">
            <div class="card-head">
                <div class="card-title"><span>âš ï¸</span> çŸ¥è­˜åº«ç¼ºå£</div>
                <span class="card-badge" style="background:${uRate > 10 ? 'var(--error-soft);color:var(--error)' : 'var(--success-soft);color:var(--success)'}">${u.count || 0} å‰‡</span>
            </div>
            ${renderGaps(u.recent || [])}
        </div>

        <!-- Low Confidence -->
        <div class="card span2">
            <div class="card-head">
                <div class="card-title"><span>ğŸ¯</span> ä½ä¿¡å¿ƒåº¦å›æ‡‰</div>
            </div>
            ${renderLowConf(lc.worst || [])}
        </div>

        <!-- Categories -->
        <div class="card span2">
            <div class="card-head">
                <div class="card-title"><span>ğŸ“‚</span> åˆ†é¡çµ±è¨ˆ</div>
            </div>
            ${renderCats(ov.categories || [])}
        </div>

        <!-- Trends -->
        <div class="card span4">
            <div class="card-head">
                <div class="card-title"><span>ğŸ“ˆ</span> æ¯æ—¥è¶¨å‹¢</div>
            </div>
            ${renderTrends(trends.daily_trends || [])}
        </div>

        <!-- AI Summary (lazy loaded) -->
        <div class="card span4" id="summaryCard">
            <div class="card-head">
                <div class="card-title"><span>ğŸ“‹</span> AI é€±å ±æ‘˜è¦</div>
            </div>
            <div class="summary-loading" id="summaryArea">
                <p>é»æ“ŠæŒ‰éˆ•ç”Ÿæˆ AI åˆ†æå ±å‘Šï¼ˆéœ€ç´„ 5-10 ç§’ï¼‰</p>
                <button class="gen-btn" onclick="loadSummary()">âœ¨ ç”Ÿæˆé€±å ±</button>
            </div>
        </div>
    `;
}

async function loadSummary() {
    const area = document.getElementById('summaryArea');
    area.innerHTML = '<div class="summary-loading"><div class="spin"></div> AI æ­£åœ¨åˆ†ææ•¸æ“šä¸¦æ’°å¯«å ±å‘Š...</div>';

    try {
        const res = await fetch(`${API}/api/analytics/weekly-summary`);
        const data = await res.json();
        area.innerHTML = '<div class="summary-box">' + fmtSummary(data.summary || 'ç„¡æ³•ç”Ÿæˆæ‘˜è¦') + '</div>';
    } catch(e) {
        area.innerHTML = '<div class="empty">âŒ ç„¡æ³•ç”Ÿæˆæ‘˜è¦</div>';
    }
}

function renderTopQ(questions) {
    if (!questions.length) return '<div class="empty">å°šç„¡æ•¸æ“š</div>';
    return `<table class="tbl">
        <tr><th></th><th>å•é¡Œ</th><th>æ¬¡æ•¸</th><th>ä¿¡å¿ƒåº¦</th></tr>
        ${questions.map((q, i) => {
            const p = Math.round((q.avg_confidence || 0) * 100);
            const cls = p > 60 ? 'high' : p > 40 ? 'mid' : 'low';
            return `<tr>
                <td><span class="rank-num ${i === 0 ? 'first' : ''}">${i+1}</span></td>
                <td style="max-width:260px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${q.question}</td>
                <td><span class="count-pill">${q.count}Ã—</span></td>
                <td><span class="conf-badge ${cls}">${p}%</span></td>
            </tr>`;
        }).join('')}
    </table>`;
}

function renderGaps(items) {
    if (!items.length) return '<div class="empty success">ğŸ‰ ç›®å‰æ²’æœ‰æœªè§£ç­”çš„å•é¡Œ</div>';
    return items.map(q => `
        <div class="gap-item">
            <div class="q">${q.question}</div>
            <div class="c">${Math.round((q.confidence||0)*100)}%</div>
        </div>
    `).join('');
}

function renderLowConf(items) {
    if (!items.length) return '<div class="empty success">ğŸ‰ æ‰€æœ‰å›æ‡‰ä¿¡å¿ƒåº¦æ­£å¸¸</div>';
    return `<table class="tbl">
        <tr><th>å•é¡Œ</th><th>ä¿¡å¿ƒåº¦</th></tr>
        ${items.map(item => {
            const p = Math.round((item.confidence||0)*100);
            return `<tr>
                <td style="max-width:300px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${item.question}</td>
                <td><span class="conf-badge low">${p}%</span></td>
            </tr>`;
        }).join('')}
    </table>`;
}

function renderCats(cats) {
    if (!cats.length) return '<div class="empty">å°šç„¡åˆ†é¡æ•¸æ“šï¼ˆéœ€åœ¨ Sheet æ–°å¢ category æ¬„ä½ï¼‰</div>';
    const max = Math.max(...cats.map(c => c.count), 1);
    return '<div class="bars">' + cats.map(c => `
        <div class="bar-row">
            <div class="bar-label">${c.category}</div>
            <div class="bar-track">
                <div class="bar-fill" style="width:${(c.count/max*100)}%">${c.count}</div>
            </div>
        </div>
    `).join('') + '</div>';
}

function renderTrends(data) {
    if (!data.length) return '<div class="empty">å°šç„¡è¶¨å‹¢æ•¸æ“š</div>';
    const max = Math.max(...data.map(t => t.message_count), 1);
    return '<div class="bars">' + data.map(t => `
        <div class="bar-row">
            <div class="bar-label">${t.date || ''}</div>
            <div class="bar-track">
                <div class="bar-fill green" style="width:${(t.message_count/max*100)}%">${t.message_count} å‰‡ Â· ${t.unique_sessions} è¨ªå®¢</div>
            </div>
        </div>
    `).join('') + '</div>';
}

function fmtSummary(text) {
    return text
        .replace(/### (.*)/g, '<h3>$1</h3>')
        .replace(/#### (.*)/g, '<h4>$1</h4>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
}

window.onload = () => load(30);
</script>

</body>
</html>
