<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½å®¢æœåŠ©ç†</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;600;700&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #fafbfe;
            --bg-chat: #ffffff;
            --bg-input: #f3f4f8;
            --bg-user: #4361ee;
            --bg-user-hover: #3a56d4;
            --bg-bot: #f0f2f8;
            --bg-bot-border: #e4e7f0;
            --text: #1a1d2e;
            --text-light: #6b7194;
            --text-muted: #9ea3bf;
            --text-on-primary: #ffffff;
            --accent: #4361ee;
            --accent-soft: rgba(67, 97, 238, 0.08);
            --border: #e8eaf2;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.04);
            --shadow-md: 0 4px 16px rgba(0,0,0,0.06);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.08);
            --radius: 20px;
            --radius-msg: 18px;
            --max-width: 780px;
            --header-h: 68px;
            --input-h: 80px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Sans TC', 'DM Sans', -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
        }

        /* â•â•â•â•â•â• Header â•â•â•â•â•â• */
        .header {
            height: var(--header-h);
            background: var(--bg-chat);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 24px;
            flex-shrink: 0;
            position: relative;
            z-index: 10;
        }

        .header-left {
            display: flex; align-items: center; gap: 12px;
        }

        .avatar {
            width: 40px; height: 40px;
            background: var(--accent);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            color: #fff; font-size: 18px;
            box-shadow: 0 2px 8px rgba(67, 97, 238, 0.3);
        }

        .header-text h1 {
            font-size: 15px; font-weight: 600; color: var(--text);
            line-height: 1.3;
        }

        .header-status {
            font-size: 12px; color: var(--text-muted);
            display: flex; align-items: center; gap: 5px;
        }

        .online-dot {
            width: 6px; height: 6px;
            background: #22c55e;
            border-radius: 50%;
        }

        .header-right {
            margin-left: auto;
            display: flex; align-items: center; gap: 8px;
        }

        .header-action {
            width: 36px; height: 36px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: transparent;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 14px;
            color: var(--text-light);
            transition: all 0.15s;
        }

        .header-action:hover {
            background: var(--accent-soft);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* â•â•â•â•â•â• Chat Area â•â•â•â•â•â• */
        .chat-area {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 24px 0;
            scroll-behavior: smooth;
        }

        .chat-area::-webkit-scrollbar { width: 5px; }
        .chat-area::-webkit-scrollbar-track { background: transparent; }
        .chat-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 5px; }

        .chat-inner {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        /* â•â•â•â•â•â• Messages â•â•â•â•â•â• */
        .msg-group {
            display: flex;
            flex-direction: column;
            gap: 3px;
            margin-bottom: 16px;
            animation: fadeUp 0.3s ease;
        }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .msg-row {
            display: flex;
            align-items: flex-end;
            gap: 8px;
        }

        .msg-row.user { justify-content: flex-end; }

        .msg-avatar-sm {
            width: 28px; height: 28px;
            border-radius: 9px;
            background: var(--accent);
            display: flex; align-items: center; justify-content: center;
            color: #fff; font-size: 12px;
            flex-shrink: 0;
            margin-bottom: 2px;
        }

        .msg-bubble {
            max-width: 520px;
            padding: 12px 16px;
            font-size: 14.5px;
            line-height: 1.75;
            letter-spacing: 0.15px;
            word-break: break-word;
        }

        .msg-row.bot .msg-bubble {
            background: var(--bg-bot);
            border: 1px solid var(--bg-bot-border);
            border-radius: 4px var(--radius-msg) var(--radius-msg) var(--radius-msg);
            color: var(--text);
        }

        .msg-row.user .msg-bubble {
            background: var(--bg-user);
            border-radius: var(--radius-msg) var(--radius-msg) 4px var(--radius-msg);
            color: var(--text-on-primary);
        }

        .msg-bubble a {
            color: var(--accent);
            text-decoration: underline;
            text-underline-offset: 2px;
        }

        .msg-row.user .msg-bubble a {
            color: rgba(255,255,255,0.9);
        }

        .msg-time {
            font-size: 11px;
            color: var(--text-muted);
            margin-top: 4px;
            padding: 0 36px;
        }

        .msg-row.user .msg-time { text-align: right; padding-right: 0; }

        /* â•â•â•â•â•â• Typing â•â•â•â•â•â• */
        .typing-row {
            display: flex; align-items: flex-end; gap: 8px;
            margin-bottom: 16px;
            animation: fadeUp 0.2s ease;
        }

        .typing-bubble {
            background: var(--bg-bot);
            border: 1px solid var(--bg-bot-border);
            border-radius: 4px var(--radius-msg) var(--radius-msg) var(--radius-msg);
            padding: 14px 18px;
            display: flex; gap: 4px;
        }

        .t-dot {
            width: 7px; height: 7px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: bounce 1.2s infinite;
        }
        .t-dot:nth-child(2) { animation-delay: 0.15s; }
        .t-dot:nth-child(3) { animation-delay: 0.3s; }

        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.35; }
            30% { transform: translateY(-5px); opacity: 1; }
        }

        /* â•â•â•â•â•â• Streaming cursor â•â•â•â•â•â• */
        .streaming .msg-bubble::after {
            content: '';
            display: inline-block;
            width: 2px; height: 16px;
            background: var(--accent);
            margin-left: 3px;
            vertical-align: text-bottom;
            animation: cursorBlink 0.7s steps(2) infinite;
        }

        @keyframes cursorBlink {
            0% { opacity: 1; } 50% { opacity: 0; }
        }

        /* â•â•â•â•â•â• Welcome â•â•â•â•â•â• */
        .welcome {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 60px 24px;
            max-width: var(--max-width);
            margin: 0 auto;
            flex: 1;
        }

        .welcome-avatar {
            width: 64px; height: 64px;
            background: var(--accent);
            border-radius: 18px;
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; color: #fff;
            box-shadow: 0 4px 20px rgba(67, 97, 238, 0.25);
            margin-bottom: 20px;
        }

        .welcome h2 {
            font-size: 20px; font-weight: 600;
            margin-bottom: 8px;
        }

        .welcome p {
            font-size: 14px;
            color: var(--text-light);
            max-width: 400px;
            line-height: 1.7;
            margin-bottom: 24px;
        }

        .suggestions {
            display: flex; flex-wrap: wrap;
            gap: 8px; justify-content: center;
        }

        .suggestion {
            padding: 9px 18px;
            background: var(--bg-chat);
            border: 1px solid var(--border);
            border-radius: 24px;
            font-size: 13px;
            color: var(--text-light);
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .suggestion:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-soft);
            transform: translateY(-1px);
        }

        /* â•â•â•â•â•â• Input â•â•â•â•â•â• */
        .input-area {
            flex-shrink: 0;
            background: var(--bg-chat);
            border-top: 1px solid var(--border);
            padding: 12px 24px 16px;
        }

        .input-inner {
            max-width: var(--max-width);
            margin: 0 auto;
        }

        .input-box {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            background: var(--bg-input);
            border: 1.5px solid var(--border);
            border-radius: 16px;
            padding: 6px 6px 6px 18px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        .input-box:focus-within {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        .input-box textarea {
            flex: 1;
            background: transparent;
            border: none;
            outline: none;
            font-size: 14.5px;
            font-family: inherit;
            color: var(--text);
            resize: none;
            max-height: 100px;
            padding: 8px 0;
            line-height: 1.5;
        }

        .input-box textarea::placeholder { color: var(--text-muted); }

        .send-btn {
            width: 40px; height: 40px;
            background: var(--bg-user);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 16px;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            transition: background 0.15s, transform 0.1s;
            flex-shrink: 0;
        }

        .send-btn:hover { background: var(--bg-user-hover); }
        .send-btn:active { transform: scale(0.93); }
        .send-btn:disabled { opacity: 0.35; cursor: not-allowed; }

        .input-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 6px;
            padding: 0 4px;
        }

        .input-hint {
            font-size: 11px; color: var(--text-muted);
        }

        .powered {
            font-size: 10px; color: var(--text-muted);
            text-decoration: none;
        }

        /* â•â•â•â•â•â• New conversation button â•â•â•â•â•â• */
        .new-chat-btn {
            position: fixed;
            bottom: 100px;
            right: 24px;
            width: 42px; height: 42px;
            background: var(--bg-chat);
            border: 1px solid var(--border);
            border-radius: 12px;
            display: none;
            align-items: center; justify-content: center;
            cursor: pointer;
            font-size: 16px;
            box-shadow: var(--shadow-md);
            transition: all 0.2s;
            z-index: 20;
        }

        .new-chat-btn:hover {
            border-color: var(--accent);
            box-shadow: var(--shadow-lg);
        }

        .new-chat-btn.show { display: flex; }

        /* â•â•â•â•â•â• Responsive â•â•â•â•â•â• */
        @media (max-width: 640px) {
            .msg-bubble { max-width: 85vw; }
            .chat-inner { padding: 0 14px; }
            .input-area { padding: 10px 14px 14px; }
            .header { padding: 0 14px; }
            .header-right { display: none; }
            .welcome { padding: 40px 16px; }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-left">
        <div class="avatar">ğŸ¤–</div>
        <div class="header-text">
            <h1>AI æ™ºèƒ½å®¢æœåŠ©ç†</h1>
            <div class="header-status"><span class="online-dot"></span> ç·šä¸Šæœå‹™ä¸­</div>
        </div>
    </div>
    <div class="header-right">
        <button class="header-action" onclick="startNewChat()" title="æ–°å°è©±">ğŸ”„</button>
    </div>
</div>

<div class="chat-area" id="chatArea">
    <div class="welcome" id="welcome">
        <div class="welcome-avatar">ğŸ’¬</div>
        <h2>æ‚¨å¥½ï¼æœ‰ä»€éº¼å¯ä»¥å¹«æ‚¨çš„å—ï¼Ÿ</h2>
        <p>æˆ‘æ˜¯æ‚¨çš„ AI æ™ºèƒ½å®¢æœåŠ©ç†ï¼Œå¯ä»¥å›ç­”é—œæ–¼èª²ç¨‹ã€æœå‹™ã€åƒ¹æ ¼ç­‰å•é¡Œã€‚æ­¡è¿éš¨æ™‚æå•ï¼</p>
        <div class="suggestions">
            <button class="suggestion" onclick="ask('ä½ å€‘æä¾›å“ªäº›èª²ç¨‹ï¼Ÿ')">ğŸ“š ä½ å€‘æä¾›å“ªäº›èª²ç¨‹ï¼Ÿ</button>
            <button class="suggestion" onclick="ask('èª²ç¨‹çš„åƒ¹æ ¼æ˜¯å¤šå°‘ï¼Ÿ')">ğŸ’° èª²ç¨‹åƒ¹æ ¼</button>
            <button class="suggestion" onclick="ask('å¦‚ä½•é€€è²»ï¼Ÿ')">ğŸ”„ é€€è²»æµç¨‹</button>
            <button class="suggestion" onclick="ask('æœ‰å…è²»è©¦çœ‹å—ï¼Ÿ')">ğŸ å…è²»è©¦çœ‹</button>
            <button class="suggestion" onclick="ask('ä½ å€‘æœ‰ Python èª²ç¨‹å—ï¼Ÿ')">ğŸ Python èª²ç¨‹</button>
            <button class="suggestion" onclick="ask('èª²ç¨‹å¯ä»¥ç”¨æ‰‹æ©Ÿçœ‹å—ï¼Ÿ')">ğŸ“± æ‰‹æ©Ÿè§€çœ‹</button>
        </div>
    </div>
</div>

<button class="new-chat-btn" id="newChatBtn" onclick="startNewChat()" title="é–‹å§‹æ–°å°è©±">âœ¨</button>

<div class="input-area">
    <div class="input-inner">
        <div class="input-box">
            <textarea
                id="input"
                placeholder="è¼¸å…¥æ‚¨çš„å•é¡Œ..."
                rows="1"
                onkeydown="onKey(event)"
                oninput="resize(this)"
            ></textarea>
            <button class="send-btn" id="sendBtn" onclick="send()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
            </button>
        </div>
        <div class="input-footer">
            <span class="input-hint">Enter ç™¼é€ Â· Shift+Enter æ›è¡Œ</span>
            <span class="powered">Powered by Class Genius</span>
        </div>
    </div>
</div>

<script>
const API = window.location.origin;
let busy = false;
let conversationHistory = [];
let sessionId = genId();
let msgCount = 0;

function genId() {
    return 'xxxx-xxxx'.replace(/x/g, () => ((Math.random()*16)|0).toString(16));
}

function $(id) { return document.getElementById(id); }

function scroll() {
    const a = $('chatArea');
    a.scrollTop = a.scrollHeight;
}

function resize(el) {
    el.style.height = 'auto';
    el.style.height = Math.min(el.scrollHeight, 100) + 'px';
}

function onKey(e) {
    if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
}

function hideWelcome() {
    const w = $('welcome');
    if (w) { w.style.display = 'none'; }
    $('newChatBtn').classList.add('show');
}

function getInner() {
    let inner = document.querySelector('.chat-inner');
    if (!inner) {
        inner = document.createElement('div');
        inner.className = 'chat-inner';
        $('chatArea').appendChild(inner);
    }
    return inner;
}

function now() {
    return new Date().toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit' });
}

function fmt(text) {
    return text
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
        .replace(/\n/g, '<br>');
}

/* â•â•â•â•â•â• Add Messages â•â•â•â•â•â• */

function addUser(text) {
    hideWelcome();
    const inner = getInner();
    const group = document.createElement('div');
    group.className = 'msg-group';
    group.innerHTML = `
        <div class="msg-row user">
            <div class="msg-bubble">${fmt(text)}</div>
        </div>
        <div class="msg-time" style="text-align:right">${now()}</div>
    `;
    inner.appendChild(group);
    scroll();
}

function addTyping() {
    const inner = getInner();
    const el = document.createElement('div');
    el.className = 'typing-row';
    el.id = 'typing';
    el.innerHTML = `
        <div class="msg-avatar-sm">ğŸ¤–</div>
        <div class="typing-bubble">
            <div class="t-dot"></div><div class="t-dot"></div><div class="t-dot"></div>
        </div>
    `;
    inner.appendChild(el);
    scroll();
}

function removeTyping() {
    const t = $('typing');
    if (t) t.remove();
}

function addBotStreaming() {
    const inner = getInner();
    const group = document.createElement('div');
    group.className = 'msg-group streaming';
    group.id = 'streamGroup';
    group.innerHTML = `
        <div class="msg-row bot">
            <div class="msg-avatar-sm">ğŸ¤–</div>
            <div class="msg-bubble" id="streamBubble"></div>
        </div>
    `;
    inner.appendChild(group);
    scroll();
    return $('streamBubble');
}

function finishStreaming(text) {
    const group = $('streamGroup');
    if (group) {
        group.classList.remove('streaming');
        group.removeAttribute('id');
        const bubble = group.querySelector('.msg-bubble');
        if (bubble) {
            bubble.removeAttribute('id');
            bubble.innerHTML = fmt(text);
        }
        // Add timestamp
        const time = document.createElement('div');
        time.className = 'msg-time';
        time.textContent = now();
        group.appendChild(time);
    }
    scroll();
}

/* â•â•â•â•â•â• Send Message â•â•â•â•â•â• */

async function send() {
    const input = $('input');
    const q = input.value.trim();
    if (!q || busy) return;

    input.value = '';
    input.style.height = 'auto';
    $('sendBtn').disabled = true;
    busy = true;

    addUser(q);
    addTyping();

    // Add user message to conversation history
    conversationHistory.push({ role: 'user', content: q });

    try {
        const res = await fetch(`${API}/api/chat/stream`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                query: q,
                session_id: sessionId,
                conversation_history: conversationHistory.length > 1 ? conversationHistory.slice(0, -1) : null,
            }),
        });

        removeTyping();

        if (!res.ok) throw new Error('fail');

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let bubble = null;
        let fullText = '';

        while (true) {
            const { done, value } = await reader.read();
            if (done) break;

            const lines = decoder.decode(value).split('\n');
            for (const line of lines) {
                if (!line.startsWith('data: ')) continue;
                try {
                    const d = JSON.parse(line.slice(6));

                    if (d.type === 'metadata') {
                        // Create the streaming bubble when we get metadata
                        bubble = addBotStreaming();
                    } else if (d.type === 'chunk') {
                        if (!bubble) bubble = addBotStreaming();
                        fullText += d.content;
                        bubble.innerHTML = fmt(fullText);
                        scroll();
                    } else if (d.type === 'done') {
                        finishStreaming(d.answer || fullText);
                        // Add assistant response to conversation history
                        conversationHistory.push({ role: 'assistant', content: d.answer || fullText });
                    }
                } catch(e) {}
            }
        }

        // Fallback if no done event
        if (fullText && !document.querySelector('.msg-group:not(.streaming) .msg-bubble:last-child')) {
            finishStreaming(fullText);
            conversationHistory.push({ role: 'assistant', content: fullText });
        }

    } catch(err) {
        removeTyping();
        const inner = getInner();
        const group = document.createElement('div');
        group.className = 'msg-group';
        group.innerHTML = `
            <div class="msg-row bot">
                <div class="msg-avatar-sm">ğŸ¤–</div>
                <div class="msg-bubble">å¾ˆæŠ±æ­‰ï¼Œç›®å‰ç„¡æ³•é€£æ¥æœå‹™ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</div>
            </div>
        `;
        inner.appendChild(group);
        scroll();
    }

    busy = false;
    $('sendBtn').disabled = false;
    $('input').focus();
    msgCount++;

    // Keep conversation history manageable (last 10 turns)
    if (conversationHistory.length > 20) {
        conversationHistory = conversationHistory.slice(-20);
    }
}

function ask(q) {
    $('input').value = q;
    send();
}

function startNewChat() {
    conversationHistory = [];
    sessionId = genId();
    msgCount = 0;

    // Clear chat
    const inner = document.querySelector('.chat-inner');
    if (inner) inner.remove();

    // Show welcome
    const w = $('welcome');
    if (w) w.style.display = '';

    $('newChatBtn').classList.remove('show');
    $('input').focus();
}

// Focus on load
$('input').focus();
</script>

</body>
</html>
